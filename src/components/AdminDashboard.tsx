import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import axios from 'axios';
import './AdminDashboard.css';

// Generated by Copilot - Enhanced Admin Dashboard with OWASP Security & CPanel Access

interface Client {
    id: string;
    nrInmatriculare: string;
    nrTelefon: string;
    valabilitate: string;
    optional?: string;
    createdAt?: string;
}

interface AdminDashboardProps {
    cpanelAccess?: boolean;
    fullPermissions?: boolean;
}

interface DashboardStats {
    totalUsers: number;
    activeUsers: number;
    verifiedUsers: number;
    pendingUsers: number;
    adminUsers: number;
    totalClients: number;
    totalVehicles: number;
}

const AdminDashboard: React.FC<AdminDashboardProps> = ({
    cpanelAccess = true,
    fullPermissions = true
}) => {
    const { user, logout } = useAuth();
    const [clients, setClients] = useState<Client[]>([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [stats, setStats] = useState<DashboardStats | null>(null);
    const [activeTab, setActiveTab] = useState('cpanel');

    // Formularul pentru clien»õi
    const [clientForm, setClientForm] = useState({
        nrInmatriculare: '',
        nrTelefon: '',
        valabilitate: '6months', // Start cu prima op»õiune predefinitƒÉ
        optional: '',
        manualDate: '' // Pentru data manualƒÉ
    });

    const [manualDateEnabled, setManualDateEnabled] = useState(false);

    // OWASP 4.5.3 - Role verification cu double-check
    useEffect(() => {
        if (!user || user.role !== 'admin') {
            setError('Acces interzis. Doar administratorii pot accesa CPanel-ul.');
            return;
        }

        // VerificƒÉ access CPanel prin API
        if (cpanelAccess && fullPermissions) {
            loadCPanelData();
            loadClients();
        } else {
            setError('Nu ai permisiunile necesare pentru accesarea CPanel-ului.');
        }
    }, [user, cpanelAccess, fullPermissions]);

    const loadCPanelData = async () => {
        try {
            setLoading(true);
            const response = await axios.get('/api/admin/cpanel', {
                withCredentials: true // Folose»ôte cookie-urile pentru autentificare
            });

            if (response.data.access === 'full') {
                setStats(response.data.dashboardStats);
            } else {
                throw new Error('Acces CPanel invalid');
            }
        } catch (err: any) {
            console.error('Eroare √ÆncƒÉrcare CPanel:', err);
            if (err.response?.status === 403) {
                setError('Acces CPanel interzis. Doar administratorii cu drepturi complete.');
            } else {
                setError('Eroare la √ÆncƒÉrcarea CPanel-ului.');
            }
        } finally {
            setLoading(false);
        }
    };

    const loadClients = async () => {
        try {
            const response = await fetch('/api/admin/clients', {
                credentials: 'include', // Folose»ôte cookie-urile pentru autentificare
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            if (data.success) {
                setClients(data.clients);
            }
        } catch (error) {
            console.error('Eroare la √ÆncƒÉrcarea clien»õilor:', error);
        }
    };

    const handleValidityChange = (value: string) => {
        setClientForm({
            ...clientForm,
            valabilitate: value
        });
        setManualDateEnabled(value === 'manual');
    };

    const handleAddClient = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();

        try {
            // PregƒÉte»ôte datele pentru trimitere
            const requestData = {
                ...clientForm
            };

            // Pentru valabilitate manualƒÉ, include data
            if (clientForm.valabilitate === 'manual') {
                if (!clientForm.manualDate) {
                    alert('Te rugƒÉm sƒÉ selectezi o datƒÉ pentru valabilitatea manualƒÉ.');
                    return;
                }
                requestData.manualDate = clientForm.manualDate;
            }

            const response = await fetch('/api/admin/clients', {
                method: 'POST',
                credentials: 'include', // Folose»ôte cookie-urile pentru autentificare
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();
            if (data.success) {
                setClients([...clients, data.client]);
                setClientForm({
                    nrInmatriculare: '',
                    nrTelefon: '',
                    valabilitate: '6months', // Reset to first predefined option
                    optional: '',
                    manualDate: ''
                });
                setManualDateEnabled(false);
                alert('Client adƒÉugat cu succes!');
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Eroare la adƒÉugarea clientului:', error);
            alert('Eroare la adƒÉugarea clientului');
        }
    };

    const formatDate = (dateString: string | undefined) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('ro-RO');
    };

    const getValidityLabel = (validity: string) => {
        const labels: { [key: string]: string } = {
            'today': 'AstƒÉzi',
            '6months': '6 luni',
            '1year': '1 an',
            '2years': '2 ani'
        };
        return labels[validity] || validity;
    };

    if (!user || user.role !== 'admin') {
        return (
            <div className="admin-dashboard">
                <div className="error-message">
                    <h2>‚õî Acces Interzis</h2>
                    <p>Doar administratorii pot accesa aceastƒÉ paginƒÉ.</p>
                    <button onClick={logout} className="btn btn-secondary">
                        √énapoi la Login
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="admin-dashboard">
            <div className="admin-header">
                <h1>üè¢ Panou Management Clien»õi</h1>
                <div className="admin-user-info">
                    <span>Bun venit, {user.firstName} {user.lastName}</span>
                    <button onClick={logout} className="btn btn-secondary btn-sm">
                        Ie»ôire
                    </button>
                </div>
            </div>

            {loading && <div className="loading">Se √ÆncarcƒÉ...</div>}
            {error && <div className="error-message">{error}</div>}

            {/* Management Clien»õi */}
            <div className="clients-content">
                <div className="clients-header">
                    <h2>üë§ Management Clien»õi</h2>
                </div>

                {/* Formular adƒÉugare client */}
                <div className="add-vehicle-form">
                    <h3>‚ûï AdaugƒÉ Client Nou</h3>
                    <form onSubmit={handleAddClient}>
                        <div className="form-row">
                            <div className="form-group">
                                <label>NumƒÉr √énmatriculare:</label>
                                <input
                                    type="text"
                                    value={clientForm.nrInmatriculare}
                                    onChange={(e) => setClientForm({
                                        ...clientForm,
                                        nrInmatriculare: e.target.value.toUpperCase()
                                    })}
                                    placeholder="B123ABC"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>NumƒÉr Telefon:</label>
                                <input
                                    type="tel"
                                    value={clientForm.nrTelefon}
                                    onChange={(e) => setClientForm({
                                        ...clientForm,
                                        nrTelefon: e.target.value
                                    })}
                                    placeholder="0756596565"
                                    required
                                />
                            </div>
                        </div>
                        <div className="form-row">
                            <div className="form-group">
                                <label>Valabilitate:</label>
                                <select
                                    value={clientForm.valabilitate}
                                    onChange={(e) => handleValidityChange(e.target.value)}
                                    required
                                    title="SelecteazƒÉ perioada de validitate - op»õiuni predefinite sunt limitate"
                                    className="validity-select-admin"
                                >
                                    <option value="6months" className="predefined-option">6 luni</option>
                                    <option value="1year" className="predefined-option">1 an</option>
                                    <option value="2years" className="predefined-option">2 ani</option>
                                    <option value="manual" className="manual-option">Manual (Deblocat)</option>
                                </select>
                            </div>
                            {manualDateEnabled && (
                                <div className="form-group">
                                    <label>Data Expirare ManualƒÉ:</label>
                                    <input
                                        type="date"
                                        value={clientForm.manualDate}
                                        onChange={(e) => setClientForm({
                                            ...clientForm,
                                            manualDate: e.target.value
                                        })}
                                        required={manualDateEnabled}
                                        title="SelecteazƒÉ data de expirare manualƒÉ"
                                        className="manual-date-input"
                                    />
                                </div>
                            )}
                            <div className="form-group">
                                <label>C√¢mp Op»õional:</label>
                                <input
                                    type="text"
                                    value={clientForm.optional}
                                    onChange={(e) => setClientForm({
                                        ...clientForm,
                                        optional: e.target.value
                                    })}
                                    placeholder="Observa»õii..."
                                />
                            </div>
                        </div>
                        <button type="submit" className="btn btn-primary">
                            ‚ûï AdaugƒÉ Client
                        </button>
                    </form>
                </div>

                {/* Lista clien»õi */}
                <div className="vehicles-list">
                    <h3>üìã Lista Clien»õi ({clients.length})</h3>
                    {clients.length === 0 ? (
                        <div className="no-vehicles">
                            <p>Nu existƒÉ clien»õi √Ænregistra»õi.</p>
                        </div>
                    ) : (
                        <div className="table-container">
                            <table className="vehicles-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nr. √énmatriculare</th>
                                        <th>Nr. Telefon</th>
                                        <th>Valabilitate</th>
                                        <th>Op»õional</th>
                                        <th>Data creƒÉrii</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {clients.map((client, index) => (
                                        <tr key={client.id || index}>
                                            <td>{client.id || index + 1}</td>
                                            <td className="nr-inmatriculare">
                                                {client.nrInmatriculare}
                                            </td>
                                            <td>{client.nrTelefon}</td>
                                            <td>
                                                <span className={`validity ${client.valabilitate}`}>
                                                    {getValidityLabel(client.valabilitate)}
                                                </span>
                                            </td>
                                            <td>{client.optional || '-'}</td>
                                            <td>{formatDate(client.createdAt)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default AdminDashboard;